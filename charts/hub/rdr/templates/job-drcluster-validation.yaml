{{- range .Values.regionalDR }}
{{ $clusterSet := .name }}
{{ $clusters := .clusters }}
{{- range .drpolicies }}
{{ $vm := coalesce (and .vmSupport "vm") "novm" }}
{{ $autoName := printf "%s-%s" .interval $vm }}
{{ $name := coalesce .name $autoName -}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: drcluster-validation-{{ $name }}
  namespace: open-cluster-management
  labels:
    app.kubernetes.io/name: drcluster-validation
    app.kubernetes.io/component: health-check
    drpolicy: {{ $name }}
  annotations:
    argocd.argoproj.io/sync-wave: "8"
spec:
  backoffLimit: 50
  activeDeadlineSeconds: 14400
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: drcluster-validator
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail
          
          echo "Starting DRCluster validation check..."
          
          # Configuration (clusterOverrides or regionalDR)
          PRIMARY_CLUSTER="{{ include "rdr.primaryClusterName" $ }}"
          SECONDARY_CLUSTER="{{ include "rdr.secondaryClusterName" $ }}"
          DRPOLICY_NAME="{{ $name }}"
          MAX_ATTEMPTS=120  # 2 hours with 1 minute intervals
          SLEEP_INTERVAL=60  # 1 minute between checks
          
          # Function to check if DRCluster is validated
          check_drcluster_validated() {
            local cluster="$1"
            
            echo "Checking DRCluster $cluster validation status..."
            
            # Check if DRCluster resource exists
            if ! oc get drcluster "$cluster" &>/dev/null; then
              echo "DRCluster $cluster does not exist yet"
              return 1
            fi
            
            # Check DRCluster status - look for validated condition
            # DRClusters have a status.conditions array with type "Validated"
            local validated_status=$(oc get drcluster "$cluster" -o jsonpath='{.status.conditions[?(@.type=="Validated")].status}' 2>/dev/null || echo "")
            
            if [[ -z "$validated_status" ]]; then
              echo "DRCluster $cluster: Validated condition not found yet"
              return 1
            fi
            
            if [[ "$validated_status" != "True" ]]; then
              echo "DRCluster $cluster: Not validated yet (status: $validated_status)"
              # Show the condition message if available
              local condition_message=$(oc get drcluster "$cluster" -o jsonpath='{.status.conditions[?(@.type=="Validated")].message}' 2>/dev/null || echo "")
              if [[ -n "$condition_message" ]]; then
                echo "  Message: $condition_message"
              fi
              return 1
            fi
            
            echo "âœ… DRCluster $cluster is validated"
            return 0
          }
          
          # Main check loop - keep retrying until both DRClusters are validated
          attempt=1
          
          while [[ $attempt -le $MAX_ATTEMPTS ]]; do
            echo "=== DRCluster Validation Check Attempt $attempt/$MAX_ATTEMPTS ==="
            
            all_validated=true
            
            # Check primary cluster
            if ! check_drcluster_validated "$PRIMARY_CLUSTER"; then
              all_validated=false
            fi
            
            # Check secondary cluster
            if ! check_drcluster_validated "$SECONDARY_CLUSTER"; then
              all_validated=false
            fi
            
            if [[ "$all_validated" == "true" ]]; then
              echo "ðŸŽ‰ Both DRClusters ($PRIMARY_CLUSTER and $SECONDARY_CLUSTER) are validated! Proceeding with DRPC deployment..."
              exit 0
            else
              echo "âŒ Not all DRClusters are validated yet. Waiting $SLEEP_INTERVAL seconds before retry..."
              sleep $SLEEP_INTERVAL
              ((attempt++))
            fi
          done
          
          echo "âŒ DRCluster validation check failed after $MAX_ATTEMPTS attempts"
          echo ""
          echo "If the message was 'DRClusterConfig is not applied to cluster':"
          echo "  Ramen has not yet applied the DR config to that managed cluster (e.g. via ManifestWork)."
          echo "  - Ensure the ODF/Ramen DR operator is installed on the hub and DRPolicy/DRCluster exist."
          echo "  - Ensure both clusters are joined (ManagedCluster) and available (hub can reach them)."
          echo "  - On the hub, check ManifestWorks in each cluster namespace for Ramen/DRClusterConfig:"
          echo "    oc get manifestwork -n $PRIMARY_CLUSTER"
          echo "    oc get manifestwork -n $SECONDARY_CLUSTER"
          echo "  - Check Ramen controller logs on the hub if ManifestWorks are missing or failing."
          echo ""
          echo "General checks:"
          echo "1. DRPolicy $DRPOLICY_NAME is created and properly configured"
          echo "2. Both clusters ($PRIMARY_CLUSTER and $SECONDARY_CLUSTER) are available and joined"
          echo "3. DR operator (Ramen/ODF) is installed and running on the hub and on both clusters"
          echo "4. ODF is properly configured on both clusters"
          echo ""
          echo "Current DRCluster status:"
          oc get drcluster "$PRIMARY_CLUSTER" -o yaml 2>/dev/null || echo "  Primary DRCluster not found or not accessible"
          oc get drcluster "$SECONDARY_CLUSTER" -o yaml 2>/dev/null || echo "  Secondary DRCluster not found or not accessible"
          exit 1
      serviceAccountName: drcluster-validation-checker
{{- end }}
{{- end }}

